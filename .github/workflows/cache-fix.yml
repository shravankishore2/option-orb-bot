name: Run OptionNotifier Bot

on:
  schedule:
    # Run every 5 minutes during trading hours IST (09:30â€“15:30)
    - cron: "*/5 4-10 * * 1-5"  # 4â€“10 UTC = 09:30â€“15:30 IST (Monâ€“Fri)
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      # ðŸ§© Step 1: Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # ðŸ§© Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ðŸ§© Step 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true

      # ðŸ§© Step 4: Restore previous session (cache for sent + backtest)
      - name: Restore previous session data
        uses: actions/cache@v4
        with:
          path: |
            sent_notifications.csv
            backtest_opening_range.csv
          key: notifier-state
          restore-keys: |
            notifier-state

      # ðŸ§© Step 5: Market hours check (IST)
      - name: Run OptionNotifier (market hours check)
        env:
          TZ: "Asia/Kolkata"
        run: |
          now=$(date +'%H:%M')
          echo "â° Current IST time: $now"
          if [[ "$now" > "09:30" && "$now" < "15:30" ]]; then
            echo "âœ… Within market hours â€” running bot"
            python main.py
          else
            echo "â¸ï¸ Market is closed â€” skipping run"
          fi

      # ðŸ§© Step 6: Save updated cache (keeps state across runs)
      - name: Save updated session data
        uses: actions/cache@v4
        with:
          path: |
            sent_notifications.csv
            backtest_opening_range.csv
          key: notifier-state-${{ github.run_id }}

      # ðŸ§© Step 7: Upload daily artifact for audit/backtesting
      - name: Upload Backtest Artifact
        if: always() # ensures upload even if script fails
        uses: actions/upload-artifact@v4
        with:
          name: backtest_opening_range
          path: backtest_opening_range.csv