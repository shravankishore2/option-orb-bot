name: Opening Range Breakout Bot

# Runs every 5 minutes during the UTC window that roughly maps to 09:30–15:30 IST.
# (UTC 04:00 - 10:00 = 09:30 - 15:30 IST). Runs Mon-Fri.
on:
  schedule:
    - cron: "*/5 4-10 * * 1-5"
  workflow_dispatch: {}

concurrency:
  group: orb-bot
  cancel-in-progress: true

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Restore previous sent log (if exists) so dedupe works across runs
      - name: Download previous sent log (artifact)
        uses: actions/download-artifact@v4
        with:
          name: sent-log
          path: .
        continue-on-error: true

      - name: Download backtest log (optional)
        uses: actions/download-artifact@v4
        with:
          name: backtest-log
          path: .
        continue-on-error: true

      # Quick guard: check IST time and exit if outside market hours.
      - name: Check market hours (IST) and exit if closed
        id: market-check
        run: |
          # determine IST time
          IST_TIME=$(TZ="Asia/Kolkata" date +'%H:%M')
          echo "Current IST time: $IST_TIME"
          # parse hour/minute into integers
          H=$(echo $IST_TIME | cut -d: -f1)
          M=$(echo $IST_TIME | cut -d: -f2)
          # convert to minutes since midnight for simple comparison
          MINUTES=$((10#$H * 60 + 10#$M))
          # market open/close in minutes (09:30 - 15:30)
          MARKET_OPEN=$((9 * 60 + 30))   # 570
          MARKET_CLOSE=$((15 * 60 + 30)) # 930

          if [ "$MINUTES" -lt "$MARKET_OPEN" ] || [ "$MINUTES" -gt "$MARKET_CLOSE" ]; then
            echo "⏸️ Market closed (IST $IST_TIME). Exiting early to avoid notifications."
            # set an output flag so we still upload artifacts afterwards
            echo "market_open=false" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "✅ Market is open (IST $IST_TIME). Proceeding to run."
            echo "market_open=true" >> $GITHUB_OUTPUT
          fi

      - name: Run the Opening Range Bot
        if: steps.market-check.outputs.market_open == 'true'
        env:
          TZ: "Asia/Kolkata"
        run: |
          echo "Running at $(date)"
          python main.py

      # If the bot didn't run because market was closed (or ran), we still upload artifacts
      - name: Upload updated sent log (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sent-log
          path: sent_notifications.csv
          retention-days: 2

      - name: Upload backtest log (artifact, optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backtest-log
          path: backtest_opening_range.csv
          retention-days: 7